<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>学生成绩信息管理系统</title>
    <!-- Bootstrap core CSS -->
    <link href="../css/bootstrap.min.css" th:href="@{/bootstrap/4.0.0/css/bootstrap.css}" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="../css/dashboard.css" th:href="@{/css/dashboard.css}" rel="stylesheet">
    <style type="text/css">
        /* Chart.js */
        @-webkit-keyframes chartjs-render-animation {
            from {
                opacity: 0.99
            }
            to {
                opacity: 1
            }
        }

        @keyframes chartjs-render-animation {
            from {
                opacity: 0.99
            }
            to {
                opacity: 1
            }
        }

        .chartjs-render-monitor {
            -webkit-animation: chartjs-render-animation 0.001s;
            animation: chartjs-render-animation 0.001s;
        }
    </style>
</head>

<body>
<!-- 引入抽取的topbar -->
<div th:replace="commons/teabar::topbar"></div>
<div class="container-fluid" style="width: 1000px; height: auto; margin-left: auto;">
    <div class="row">
        <main role="main" class="col-md-9 ml-sm-auto col-lg-10 pt-3 px-4">
            <h2>
                <a class="btn btn-info" href="addResult.html">成绩添加</a>
<!--                <a style="float: right" class="btn btn-outline-secondary" href="javascript:void(0);" id="getAllResultsBtn">查询所有学生成绩信息</a>-->
            </h2>
            <form method="get" th:action="@{/tea/selectById/1}">
                <div class="input-group mb-3">
                    <input type="text" class="form-control" name="stuId" placeholder="请输入学号" aria-label="请输入学号" aria-describedby="button-addon2">
                    <div class="input-group-append">
                        <button class="btn btn-outline-secondary" type="submit" id="button-addon2">查询</button>
                    </div>
                </div>
            </form>

            <div class="table-responsive">
                <table class="table table-striped table-sm" id="allResultsTable">
                    <thead>
                    <tr>
                        <th>学号</th>
                        <th>课程名</th>
                        <th>成绩</th>
                        <th>学期</th>
                        <th>操作</th>
                    </tr>
                    </thead>
                    <tbody>
                    <!-- 动态生成的内容将插入到这里 -->
                    </tbody>
                </table>
            </div>

            <!-- 分页信息 -->
            <nav aria-label="Page navigation example">
                <ul class="pagination justify-content-center">
                    <li class="page-item"><a class="page-link" href="#" th:href="@{/tea/toteadmin/1}">首页</a></li>
                    <li class="page-item" th:classappend="${pageInfo.hasPreviousPage}?'':' disabled'">
                        <a class="page-link" href="#" th:href="@{/tea/toteadmin/}+${pageInfo.pageNum-1}" tabindex="-1" aria-disabled="true">上一页</a>
                    </li>

                    <li class="page-item" th:each="page_Num:${pageInfo.navigatepageNums}">
                        <a class="page-link" th:text="${page_Num}" th:href="@{/tea/toteadmin/}+${page_Num}" th:if="${page_Num}==${pageInfo.pageNum}" th:style="'font-weight:bold;background: #6faed9;'">1</a>
                    </li>

                    <li class="page-item" th:classappend="${pageInfo.hasNextPage}?'':' disabled'">
                        <a class="page-link" href="#" th:href="@{/tea/toteadmin/}+${pageInfo.pageNum+1}">下一页</a>
                    </li>
                    <li class="page-item"><a class="page-link" href="#" th:href="@{/tea/toteadmin/}+${pageInfo.pages}">末页</a></li>
                </ul>
            </nav>
        </main>
        <form id="deleteEmpForm" method="post">
            <input type="hidden" name="_method" value="delete" />
        </form>
    </div>
</div>

</body>
</html>

<!-- 引入 Axios -->
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
    let result = [];
    // 页面加载完成后执行查询
    document.addEventListener('DOMContentLoaded', function() {
        getAllResults();
    });

    // 获取所有成绩数据
    function getAllResults() {
        axios({
            url: "http://localhost:8081/tea/getAllResult",
            method: "post"
        }).then((response) => {
            if (response.data.code === 200 && response.data.data && response.data.data.length > 0) {
                result=response.data;
                renderTable(result);
            } else {
                console.log('没有成绩数据或数据为空');
                alert('没有找到任何成绩信息');
            }
        }).catch((error) => {
            console.error('请求失败：', error);
            alert('查询失败，请稍后再试');
        });
    }
    // 根据Id查询
    document.getElementById('queryForm').addEventListener('submit', function(event) {
        event.preventDefault();
        let stuIdInput = document.querySelector('[name="stuId"]').value;

        axios({
            url: "http://localhost:8081/tea/getByResId",
            method: "post",
            data: {
                stuId: stuIdInput
            }
        }).then((response) => {
            console.log("Response from server:", response.data);  // 打印完整的响应数据
            if (response.data.code === 200 && Array.isArray(response.data.data) && response.data.data.length > 0) {
                renderTable({ data: response.data.data });  // 确保传递给renderTable的是一个包含data属性的对象
            } else {
                alert('查询失败');
            }
        }).catch((error) => {
            console.error('Error during request:', error);
            alert('查询失败，请稍后再试' + error);
        });
    });



    function renderTable(data) {
        const results = data.data || [];
        const tableBody = document.getElementById('allResultsTable').getElementsByTagName('tbody')[0];
        tableBody.innerHTML = '';
        results.forEach(item => {
            const row = document.createElement('tr');

            // 添加数据列
            ['stuId', 'subName', 'resNum', 'resTerm'].forEach(field => {
                const cell = document.createElement('td');
                cell.textContent = item[field] || '';
                row.appendChild(cell);
            });

            // 修改操作按钮部分
            const actionCell = document.createElement('td');

            const editButton = document.createElement('button');
            editButton.textContent = '编辑';
            editButton.classList.add('btn', 'btn-sm', 'btn-primary', 'mr-2');
            editButton.onclick = () => editResult(item.stuId, item.subName, item.resNum, item.resTerm);

            const deleteButton = document.createElement('button');
            deleteButton.textContent = '删除';
            deleteButton.classList.add('btn', 'btn-sm', 'btn-danger');
            // 使用 item.resId 而不是索引
            deleteButton.onclick = () => {console.log('删除按钮点击，resId:', item.resId); // 添加调试日志
                confirmDelete(item.resId);}

            actionCell.appendChild(editButton);
            actionCell.appendChild(document.createTextNode(' '));
            actionCell.appendChild(deleteButton);

            row.appendChild(actionCell);
            tableBody.appendChild(row);
        });
    }

    // 修改删除确认函数
    function confirmDelete(resId) {
        if (!resId) {
            alert('未找到成绩ID');
            return;
        }

        console.log(resId);
        if (confirm('确定要删除这条成绩记录吗？')) {
            axios({
                url: `http://localhost:8081/tea/deleteResult`,
                method: "delete",
                data:{
                    resId:resId
                }
            }).then((response) => {
                if (response.data.code === 200) {
                    alert('删除成功！');
                    // 重新加载表格数据
                    getAllResults();
                } else {
                    alert('删除失败：' + response.data.msg);
                }
            }).catch((error) => {
                console.error('删除失败：', error);
                alert('删除失败，请稍后重试');
            });
        }
    }

    // 编辑成绩
    function editResult(stuId, subName, resNum, resTerm) {
        const params = new URLSearchParams({
            stuId: stuId,
            subName: subName,
            resNum: resNum,
            resTerm: resTerm
        });
        window.location.href = `/tea/updateResultByid.html?${params.toString()}`;
    }


</script>