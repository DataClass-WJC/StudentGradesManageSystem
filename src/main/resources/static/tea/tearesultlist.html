<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>学生成绩信息管理系统</title>
    <!-- Bootstrap core CSS -->
    <link href="../css/bootstrap.min.css" th:href="@{/bootstrap/4.0.0/css/bootstrap.css}" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="../css/dashboard.css" th:href="@{/css/dashboard.css}" rel="stylesheet">
    <style type="text/css">
        /* Chart.js */
        @-webkit-keyframes chartjs-render-animation {
            from {
                opacity: 0.99
            }
            to {
                opacity: 1
            }
        }

        @keyframes chartjs-render-animation {
            from {
                opacity: 0.99
            }
            to {
                opacity: 1
            }
        }

        .chartjs-render-monitor {
            -webkit-animation: chartjs-render-animation 0.001s;
            animation: chartjs-render-animation 0.001s;
        }
    </style>
</head>

<body>
    <!-- Static Topbar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <a class="navbar-brand nav-link" href="#" style="color: black">教师页面</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ml-auto">
                <li class="nav-item active">
                    <a class="nav-link" href="/commons/teabar.html">首页 <span class="sr-only">(current)</span></a>
                </li>
                <li class="nav-item text-nowrap">
                    <a class="nav-link" href="/login.html">退出</a>
                </li>
            </ul>
        </div>
    </nav>
    <div class="container-fluid" style="width: 1000px; height: auto; margin-left: auto;">
        <div class="row">
            <!-- Static Sidebar -->
            <nav class="col-md-2 d-none d-md-block bg-light sidebar" id="sidebar">
                <div class="sidebar-sticky">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link active" href="/commons/teabar.html">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-home"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
                                首页 <span class="sr-only">(current)</span>
                            </a>
                        </li>
<!--                        <li class="nav-item">-->
<!--                            <a class="nav-link" href="../tea/ad.html">-->
<!--                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-users">-->
<!--                                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>-->
<!--                                    <circle cx="9" cy="7" r="4"></circle>-->
<!--                                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>-->
<!--                                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>-->
<!--                                </svg>-->
<!--                                个人信息-->
<!--                            </a>-->
<!--                        </li>-->
                        <li class="nav-item">
                            <a class="nav-link" href="../tea/tearesultlist.html">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-users">
                                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                    <circle cx="9" cy="7" r="4"></circle>
                                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                                </svg>
                                学生成绩管理
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- 引入抽取的topbar -->
            <div th:replace="commons/teabar::topbar"></div>
            <div class="container-fluid" style="width: 1000px; height: auto; margin-left: auto;">
                <div class="row">
                    <main role="main" class="col-md-9 ml-sm-auto col-lg-10 pt-3 px-4">
                        <h2>
                            <a class="btn btn-info" href="addResult.html">成绩添加</a>
                            <a style="float: right" class="btn btn-outline-secondary" href="javascript:void(0);" id="getAllResultsBtn">查询所有学生成绩信息</a>
                        </h2>
                        <form id="queryForm" method="get" th:action="@{/tea/selectById/1}">
                            <div class="input-group mb-3">
                                <input type="text" class="form-control" name="stuId" placeholder="请输入学号" aria-label="请输入学号" aria-describedby="button-addon2">
                                <div class="input-group-append">
                                    <button class="btn btn-outline-secondary" type="submit" id="button-addon2">查询</button>
                                </div>
                            </div>
                        </form>

                        <div class="table-responsive">
                            <table class="table table-striped table-sm" id="allResultsTable">
                                <thead>
                                <tr>
                                    <th>学号</th>
                                    <th>课程名</th>
                                    <th>成绩</th>
                                    <th>学期</th>
                                    <th>操作</th>
                                </tr>
                                </thead>
                                <tbody>
                                <!-- 动态生成的内容将插入到这里 -->
                                </tbody>
                            </table>
                        </div>

                        <!-- 分页信息 -->
                        <nav aria-label="Page navigation example">
                            <ul class="pagination justify-content-center">
                                <li class="page-item"><a class="page-link" href="#" th:href="@{/tea/toteadmin/1}">首页</a></li>
                                <li class="page-item" th:classappend="${pageInfo.hasPreviousPage}?'':' disabled'">
                                    <a class="page-link" href="#" th:href="@{/tea/toteadmin/}+${pageInfo.pageNum-1}" tabindex="-1" aria-disabled="true">上一页</a>
                                </li>

                                <li class="page-item" th:each="page_Num:${pageInfo.navigatepageNums}">
                                    <a class="page-link" th:text="${page_Num}" th:href="@{/tea/toteadmin/}+${page_Num}" th:if="${page_Num}==${pageInfo.pageNum}" th:style="'font-weight:bold;background: #6faed9;'">1</a>
                                </li>

                                <li class="page-item" th:classappend="${pageInfo.hasNextPage}?'':' disabled'">
                                    <a class="page-link" href="#" th:href="@{/tea/toteadmin/}+${pageInfo.pageNum+1}">下一页</a>
                                </li>
                                <li class="page-item"><a class="page-link" href="#" th:href="@{/tea/toteadmin/}+${pageInfo.pages}">末页</a></li>
                            </ul>
                        </nav>
                    </main>
                    <form id="deleteEmpForm" method="post">
                        <input type="hidden" name="_method" value="delete" />
                    </form>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
<!-- 引入 Axios -->
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
    let result = [];
    // 渲染表格函数
    function renderTable(data) {
        // 确保data.data是你要遍历的对象数组
        const results = data.data || [];
        const tableBody = document.getElementById('allResultsTable').getElementsByTagName('tbody')[0];
        tableBody.innerHTML = '';  // 清空现有的行

        // 定义要渲染的字段名
        const fields = ['stuId', 'subName', 'resNum', 'resTerm'];

        // 遍历结果并为每个结果创建一行
        results.forEach((item, index) => {
            const row = document.createElement('tr');

            // 创建单元格并添加到行中，只针对定义的字段
            fields.forEach(field => {
                const cell = document.createElement('td');
                cell.textContent = item[field] !== undefined ? item[field] : '';
                row.appendChild(cell);
            });

            // 添加操作按钮（假设需要一个编辑和删除按钮）
            const actionCell = document.createElement('td');
            const editButton = document.createElement('button');
            editButton.textContent = '编辑';
            editButton.classList.add('btn', 'btn-sm', 'btn-primary');  // 假设使用了Bootstrap样式
            editButton.onclick = () => editResult(index);  // 编辑函数待定义

            const deleteButton = document.createElement('button');
            deleteButton.textContent = '删除';
            //给其绑定用户id
            deleteButton.setAttribute("id",item.stuId);
            deleteButton.classList.add('btn', 'btn-sm', 'btn-danger');
            deleteButton.onclick = () => deleteResult(index);  // 删除函数待定义
            actionCell.appendChild(editButton);
            actionCell.appendChild(document.createTextNode(' '));  // 添加一点间隔
            actionCell.appendChild(deleteButton);

            row.appendChild(actionCell);
            tableBody.appendChild(row);
        });
    }

    // 查询所有学生成绩信息
    // 定义一个获取所有成绩结果的函数
    function fetchAllResults() {
        axios({
            url: "http://localhost:8081/tea/getAllResult",
            method: "post"
        }).then((response) => {
            console.log(response.data);  // 打印完整的响应数据
            if (response.data.code === 200 && response.data.data && response.data.data.length > 0) {
                result = response.data;
                renderTable(result);
            } else {
                console.log('没有成绩数据或数据为空');
                alert('没有找到任何成绩信息');
            }
        }).catch((error) => {
            console.error('请求失败：', error);
            alert('查询失败，请稍后再试');
        });
    }

    // 当DOM完全加载后执行
    document.addEventListener('DOMContentLoaded', function() {
        // 页面加载完成后自动获取所有结果
        fetchAllResults();

        // 如果你仍然想要保留按钮的功能，可以添加下面这行代码
        document.getElementById('getAllResultsBtn').addEventListener('click', fetchAllResults);
    });

    // 根据Id查询
    document.getElementById('queryForm').addEventListener('submit', function(event) {
        event.preventDefault();
        let stuIdInput = document.querySelector('[name="stuId"]').value;

        axios({
            url: "http://localhost:8081/tea/getByResId",
            method: "post",
            data: {
                stuId: stuIdInput
            }
        }).then((response) => {
            console.log("Response from server:", response.data);  // 打印完整的响应数据
            if (response.data.code === 200 && Array.isArray(response.data.data) && response.data.data.length > 0) {
                renderTable({ data: response.data.data });  // 确保传递给renderTable的是一个包含data属性的对象
            } else {
                alert('查询失败');
            }
        }).catch((error) => {
            console.error('Error during request:', error);
            alert('查询失败，请稍后再试' + error);
        });
    });

    // 定义编辑和删除函数 (这里仅作为示例)
    function editResult(index) {
        alert(`编辑第${index + 1}条成绩`);
        // 这里可以放置编辑逻辑
    }
    // 确认删除功能
    function confirmDelete(resId) {
        if (confirm('确定要删除该成绩吗？')) {
            axios({
                url: `http://localhost:8081/tea/deleteResult/${resId}`,
                method: "post",
                data: {
                    _method: 'delete'  // 模拟 DELETE 请求
                }
            }).then((response) => {
                if (response.data.code === 200) {
                    alert('删除成功');
                    // 重新加载成绩列表
                    getAllResults();
                } else {
                    alert('删除失败');
                }
            }).catch((error) => {
                console.error('删除失败：', error);
                alert('删除失败，请稍后再试');
            });
        }
    }
    // 重新加载成绩列表（用于删除后刷新）
    function getAllResults() {
        axios({
            url: "http://localhost:8081/tea/getAllResult",
            method: "post"
        }).then((response) => {
            if (response.data.code === 200 && response.data.data && response.data.data.length > 0) {
                renderTable(response.data.data);
            } else {
                console.log('没有成绩数据或数据为空');
                alert('没有找到任何成绩信息');
            }
        }).catch((error) => {
            console.error('请求失败：', error);
            alert('查询失败，请稍后再试');
        });
    }
</script>